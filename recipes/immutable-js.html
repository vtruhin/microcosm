<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title></title>

    <meta property="og:title" content="Microcosm" />
    <meta property="og:description" content="Flux with actions at center stage. Write optimistic updates, cancel requests, and track changes with ease."
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://code.viget.com/microcosm" />
    <meta property="og:image" content="http://code.viget.com/microcosm/assets/microcosm-badge.png" />

    <link rel="stylesheet" href="http://code.viget.com/microcosm/assets/style.css" />
  </head>
  <body>
    <header class="header fill-bloom">
      <div class="header__inner">
        <a href="http://code.viget.com/microcosm">
          <img src="http://code.viget.com/microcosm/assets/microcosm-white.svg" alt="Microcosm" height="24" width="207" />
        </a>

        <nav class="nav">
          <a href="http://code.viget.com/microcosm/guides/quickstart.html">Guides</a>
          <a href="https://github.com/vigetlabs/microcosm">Github</a>
        </nav>
      </div>
    </header>

    <main class="main -with-sidebar">
      <aside class="sidebar">
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Introduction</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/guides/quickstart.html">Quickstart</a></li>
            <li><a href="http://code.viget.com/microcosm/guides/architecture.html">Architecture</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Recipes</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/recipes/ajax.html">AJAX</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/react-router.html">React Router</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/immutable-js.html">ImmutableJS</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Testing</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/recipes/testing-domains.html">Domains</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/testing-intents.html">Intents</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">API</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/api/microcosm.html">Microcosm</a></li>
            <li><a href="http://code.viget.com/microcosm/api/domains.html">Domains</a></li>
            <li><a href="http://code.viget.com/microcosm/api/actions.html">Actions</a></li>
            <li><a href="http://code.viget.com/microcosm/api/effects.html">Effects</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Addons</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/api/presenter.html">Presenter</a></li>
            <li><a href="http://code.viget.com/microcosm/api/form.html">Form</a></li>
            <li><a href="http://code.viget.com/microcosm/api/with-intent.html">withIntent</a></li>
          </ul>
        </section>
      </aside>

      <div class="content"><h1 id="immutablejs-integration">ImmutableJS Integration</h1>
<ol style="list-style-type: decimal">
<li><a href="#immutable-everywhere">Immutable Everywhere</a></li>
<li><a href="#immutable-in-vanilla-out">Immutable in, Vanilla out</a></li>
</ol>
<h2 id="immutable-everywhere">Immutable Everywhere</h2>
<p>The most basic integration method is to simply use ImmutableJS:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> Immutable <span class="im">from</span> <span class="st">&#39;immutable&#39;</span>
<span class="im">import</span> actions <span class="im">from</span> <span class="st">&#39;actions&#39;</span>

<span class="kw">const</span> Domain <span class="op">=</span> <span class="op">{</span>
  <span class="at">getInitialState</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">Immutable</span>.<span class="at">Map</span>()
  <span class="op">},</span>

  <span class="at">add</span>(state<span class="op">,</span> record) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">state</span>.<span class="at">set</span>(<span class="va">record</span>.<span class="at">id</span><span class="op">,</span> record)
  <span class="op">},</span>

  <span class="at">remove</span>(state<span class="op">,</span> id) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">state</span>.<span class="at">remove</span>(id)
  <span class="op">},</span>

  <span class="at">register</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      [<span class="va">actions</span>.<span class="at">create</span>]<span class="op">:</span> <span class="kw">this</span>.<span class="at">add</span><span class="op">,</span>
      [<span class="va">actions</span>.<span class="at">destroy</span>]<span class="op">:</span> <span class="kw">this</span>.<span class="at">remove</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<h2 id="immutable-in-vanilla-out">Immutable in, Vanilla out</h2>
<p>We’ve found it can be much simpler to expose vanilla JavaScript data to our presentation layer. Unfortunately, this tends to mitigate much of the benefit of immutable data. It also can impose serious performance penalties marshalling between the two formats.</p>
<p>It is worth walking through the phases of state a Microcosm works through in order to better understand how Microcosm accommodates this use case:</p>
<ol style="list-style-type: decimal">
<li><strong>archive</strong> - For performance, Microcosm purges old actions and writes their final result to a cache.</li>
<li><strong>staging</strong> - State before a making change. This is a preparatory state allowing domains the ability to transform data one last time before assigning it publicly.</li>
<li><strong>state</strong> - Publicaly available state. This is what is exposed via <code>repo.state</code>,</li>
</ol>
<p>Essentially, Microcosm can maintain ImmutableJS data structures internally, exposing plain JavaScript for public consumption. There are two key methods responsible for this:</p>
<ol style="list-style-type: decimal">
<li><strong>commit</strong> - A middleware function that dictates how a domain assigns to <code>repo.state</code>.</li>
<li><strong>shouldCommit</strong> - A predicate function that controls invocation of <code>commit</code>.</li>
</ol>
<p>In practice, this results in a small adjustment to the domain described earlier:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> Immutable <span class="im">from</span> <span class="st">&#39;immutable&#39;</span>
<span class="im">import</span> actions <span class="im">from</span> <span class="st">&#39;actions&#39;</span>

<span class="kw">const</span> Domain <span class="op">=</span> <span class="op">{</span>
  <span class="at">getInitialState</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">Immutable</span>.<span class="at">Map</span>()
  <span class="op">},</span>

  <span class="at">shouldCommit</span>(last<span class="op">,</span> next) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">Immutable</span>.<span class="at">is</span>(last<span class="op">,</span> next) <span class="op">===</span> <span class="kw">false</span>
  <span class="op">},</span>

  <span class="at">commit</span>(next) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">Array</span>.<span class="at">from</span>(<span class="va">next</span>.<span class="at">values</span>())
  <span class="op">},</span>

  <span class="at">add</span>(state<span class="op">,</span> record) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">state</span>.<span class="at">set</span>(<span class="va">record</span>.<span class="at">id</span><span class="op">,</span> record)
  <span class="op">},</span>

  <span class="at">remove</span>(state<span class="op">,</span> id) <span class="op">{</span>
    <span class="cf">return</span> <span class="va">state</span>.<span class="at">remove</span>(id)
  <span class="op">},</span>

  <span class="at">register</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      [<span class="va">actions</span>.<span class="at">create</span>]<span class="op">:</span> <span class="kw">this</span>.<span class="at">add</span><span class="op">,</span>
      [<span class="va">actions</span>.<span class="at">destroy</span>]<span class="op">:</span> <span class="kw">this</span>.<span class="at">remove</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Here we’ve added a <code>shouldCommit</code> that utilizes the <code>Immutable.is</code> equality check. Additionally, <code>commit</code> describes how <code>Immutable</code> should convert into a regular form. In this case, it will convert into an Array.</p></div>
    </main>

    <footer class="footer">
      <div class="footer__inner">
        <nav class="footer__left">
          <a href="https://www.npmjs.com/package/microcosm">
            <img src="https://img.shields.io/npm/v/microcosm.svg?style=flat-square" alt="View package on NPM" />
          </a>
          <a href="http://code.viget.com/microcosm/changelog.html">Changelog</a>
          <a href="https://github.com/vigetlabs/microcosm">Source</a>
        </nav>
        <div class="footer__right">
          Built with patience and time by <a href="https://viget.com">●° Viget</a>
        </div>
      </div>
    </footer>

    <script>
      // set active links
      (function() {
        var location = window.location.toString()

        for (var i = 0; i < document.links.length; i++) {
          if (document.links[i].href === location) {
            document.links[i].classList.add('active')
          }
        }
      }())
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title></title>

    <meta property="og:title" content="Microcosm" />
    <meta property="og:description" content="Flux with actions at center stage. Write optimistic updates, cancel requests, and track changes with ease."
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://code.viget.com/microcosm" />
    <meta property="og:image" content="http://code.viget.com/microcosm/assets/microcosm-badge.png" />

    <link rel="stylesheet" href="http://code.viget.com/microcosm/assets/style.css" />
  </head>
  <body>
    <header class="header fill-bloom">
      <div class="header__inner">
        <a href="http://code.viget.com/microcosm">
          <img src="http://code.viget.com/microcosm/assets/microcosm-white.svg" alt="Microcosm" height="24" width="207" />
        </a>

        <nav class="nav">
          <a href="http://code.viget.com/microcosm/guides/quickstart.html">Guides</a>
          <a href="https://github.com/vigetlabs/microcosm">Github</a>
        </nav>
      </div>
    </header>

    <main class="main -with-sidebar">
      <aside class="sidebar">
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Introduction</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/guides/quickstart.html">Quickstart</a></li>
            <li><a href="http://code.viget.com/microcosm/guides/architecture.html">Architecture</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Recipes</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/recipes/ajax.html">AJAX</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/react-router.html">React Router</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/immutable-js.html">ImmutableJS</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Testing</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/recipes/testing-domains.html">Domains</a></li>
            <li><a href="http://code.viget.com/microcosm/recipes/testing-intents.html">Intents</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">API</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/api/microcosm.html">Microcosm</a></li>
            <li><a href="http://code.viget.com/microcosm/api/domains.html">Domains</a></li>
            <li><a href="http://code.viget.com/microcosm/api/actions.html">Actions</a></li>
            <li><a href="http://code.viget.com/microcosm/api/effects.html">Effects</a></li>
          </ul>
        </section>
        <section class="sidebar__group">
          <h4 class="sidebar__heading">Addons</h4>
          <ul>
            <li><a href="http://code.viget.com/microcosm/api/presenter.html">Presenter</a></li>
            <li><a href="http://code.viget.com/microcosm/api/form.html">Form</a></li>
            <li><a href="http://code.viget.com/microcosm/api/with-intent.html">withIntent</a></li>
          </ul>
        </section>
      </aside>

      <div class="content"><h1 id="architecture">Architecture</h1>
<p>In this guide, we’ll walk through how Microcosm apps are organized, and how all of the pieces work together.</p>
<h2 id="model-view-presenter">Model-View-Presenter</h2>
<p>We recommend following the <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter">Model-View-Presenter (MVP)</a> pattern. This influences the project folder structure:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">src/</span>
├── <span class="ex">actions</span>
├── <span class="ex">domains</span>
├── <span class="ex">effects</span>
├── <span class="ex">presenters</span>
├── <span class="ex">views</span>
├── <span class="ex">repo.js</span>
├── <span class="ex">index.js</span>
└── <span class="ex">routes.js</span></code></pre></div>
<h2 id="routing">Routing</h2>
<p>Whenever the application boots, Microcosm apps use a router such as <a href="https://github.com/reactjs/react-router">React Router</a> or <a href="https://github.com/KidkArolis/cherrytree-for-react">CherryTree</a> to determine where a user has entered into the application.</p>
<p>This yields a list of high responsibility route handler components (Presenters), resulting in a nested structure similar to a <a href="https://www.google.com/search?q=russian+doll&amp;espv=2&amp;biw=1440&amp;bih=799&amp;source=lnms&amp;tbm=isch&amp;sa=X&amp;ved=0ahUKEwiOnOCd08nQAhVLKiYKHZSRAU8Q_AUIBigB#tbm=isch&amp;q=russian+doll&amp;chips=q:russian+doll,g_1:traditional">Russian doll</a>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">url</span>: http://my-planets-site.dev/planets/1

<span class="ex">+---------</span> [App] ----------+
<span class="kw">|</span> <span class="ex">+-----</span> [Planets] ------+ <span class="kw">|</span>
<span class="kw">|</span> <span class="kw">|</span> <span class="ex">+-----+</span> +--[Show]--+ <span class="kw">|</span> <span class="kw">|</span>
<span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span>     <span class="kw">|</span> <span class="kw">|</span>          <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span>
<span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span>     <span class="kw">|</span> <span class="kw">|</span>          <span class="kw">|</span> <span class="kw">|</span> <span class="kw">|</span>
<span class="kw">|</span> <span class="kw">|</span> <span class="ex">+-----+</span> +----------+ <span class="kw">|</span> <span class="kw">|</span>
<span class="kw">|</span> <span class="ex">+----------------------+</span> <span class="kw">|</span>
<span class="ex">+--------------------------+</span></code></pre></div>
<p>This URL might map to the following:</p>
<ol style="list-style-type: decimal">
<li><strong>Application wide layout.</strong> Global navigation, system wide notifications.</li>
<li><strong>Planets section layout.</strong> UI specific to the Planets section, like a sidebar of all planets.</li>
<li><strong>Planet specific layout.</strong> A card with specific stats about a planet.</li>
</ol>
<p>Each Presenter is given the application’s instance of Microcosm. We call it the <code>repo</code>. Since Presenters extend from <code>React.Component</code>, they receive nested routes as children (renderable by their view).</p>
<h2 id="presenters">Presenters</h2>
<p>Presenters are high-level UI components that form a wall between the data layer and the vast majority of the presentation layer. Presenters build a view model by extracting information from the data layer, sending that into “passive views”.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">class</span> PlanetsIndex <span class="kw">extends</span> Presenter <span class="op">{</span>
  view <span class="op">=</span> PlanetsList

  <span class="at">model</span> ()  <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      <span class="dt">planets</span><span class="op">:</span> state <span class="op">=&gt;</span> <span class="va">state</span>.<span class="at">planets</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Additionally, each Presenter receives a “fork” of their Microcosm instance. This fork receives data updates from its parent, however can add additional domains or effects for specific use cases. This allows Microcosm applications to be broken up into logical chunks.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">class</span> PlanetsIndex <span class="kw">extends</span> Presenter <span class="op">{</span>
  <span class="at">setup</span> (repo) <span class="op">{</span>
    <span class="va">repo</span>.<span class="at">addDomain</span>(<span class="st">&#39;special&#39;</span><span class="op">,</span> UseCase)
  <span class="op">}</span>
  <span class="co">//...</span>
<span class="op">}</span></code></pre></div>
<h2 id="views">Views</h2>
<p>Presenters maintain a strong separation between the data layer and the presentation layer. Views should know as little about the application as possible. This makes them easy to reason about, test, and reuse.</p>
<p>At their simplest, Views are just React components:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">PlanetsList</span> (<span class="op">{</span> planets<span class="op">=</span>[] <span class="op">}</span>) <span class="op">{</span>
  <span class="cf">if</span> (<span class="va">planets</span>.<span class="at">length</span> <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">{</span>
    <span class="cf">return</span> <span class="op">&lt;</span>p<span class="op">&gt;</span>No Planets<span class="op">&lt;</span><span class="ss">/p&gt;</span>
<span class="ss">  }</span>

<span class="ss">  return </span><span class="sc">(</span>
<span class="ss">    &lt;ul&gt;</span>
<span class="ss">      {planets.map</span><span class="sc">(</span><span class="ss">p =&gt; &lt;li key={p.id}&gt;{p.name}&lt;/li</span><span class="op">&gt;</span>)<span class="op">}</span>
    <span class="op">&lt;</span><span class="ss">/ul&gt;</span>
<span class="ss">  </span><span class="sc">)</span>
<span class="ss">}</span></code></pre></div>
<p>However they can also communicate user actions back to the application using <em>Intents</em>.</p>
<h3 id="intents">Intents</h3>
<p>Intents provide a way for views to report on user behavior in a way that does not couple them to specific implementation details within a Presenter. A View can simply broadcast that something has happened, allowing a Presenter (or a test) to pick on on that behavior.</p>
<p>By wrapping a View with the <code>withIntent</code> add-on, Views receive a <code>send</code> prop that allows them to broadcast Intents.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span>
<span class="im">import</span> withIntent <span class="im">from</span> <span class="st">&#39;microcosm/addons/with-intent&#39;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">withIntent</span>(<span class="kw">function</span> <span class="at">DeleteButton</span> (<span class="op">{</span> send<span class="op">,</span> id <span class="op">}</span>) <span class="op">{</span>
  <span class="cf">return</span> (
    <span class="op">&lt;</span>button onClick<span class="op">={</span>() <span class="op">=&gt;</span> <span class="at">send</span>(<span class="st">&#39;delete&#39;</span><span class="op">,</span> id)<span class="op">}&gt;</span>Delete<span class="op">&lt;</span><span class="ss">/button&gt;</span>
<span class="ss">  </span><span class="sc">)</span>
<span class="ss">}</span><span class="sc">)</span></code></pre></div>
<p>By implementing a <code>register</code> method, a Presenter can subscribe to these intents, adding intermediary processing or just push an action:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">class</span> PlanetsShow <span class="kw">extends</span> Presenter <span class="op">{</span>
  <span class="at">register</span> () <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      <span class="st">&#39;delete&#39;</span><span class="op">:</span> (repo<span class="op">,</span> id) <span class="op">=&gt;</span> <span class="va">repo</span>.<span class="at">push</span>(deletePlanet<span class="op">,</span> id)
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Or, Intents can also take the form of Actions:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span>
<span class="im">import</span> withIntent <span class="im">from</span> <span class="st">&#39;microcosm/addons/with-intent&#39;</span>
<span class="im">import</span> <span class="op">{</span>deletePlanet<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;actions/planets&#39;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">withIntent</span>(<span class="kw">function</span> <span class="at">DeleteButton</span> (<span class="op">{</span> send<span class="op">,</span> id <span class="op">}</span>) <span class="op">{</span>
  <span class="cf">return</span> (
    <span class="op">&lt;</span>button onClick<span class="op">={</span>() <span class="op">=&gt;</span> <span class="at">send</span>(deletePlanet<span class="op">,</span> id)<span class="op">}&gt;</span>Delete<span class="op">&lt;</span><span class="ss">/button&gt;</span>
<span class="ss">  </span><span class="sc">)</span>
<span class="ss">}</span><span class="sc">)</span></code></pre></div>
<p>In this case, there’s no need for the Presenter to intercept the event. If no Presenter registers to a given intent, it will get passed along to the Repo.</p>
<h2 id="actions">Actions</h2>
<p>The message format for the application. In the context of Microcosm, an action contains information on the state of its progress as well as any associated data.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">createPlanet</span> (body) <span class="op">{</span>
  <span class="co">// Fetch returns a Promise</span>
  <span class="co">// https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</span>
  <span class="cf">return</span> <span class="at">fetch</span>(<span class="st">&#39;/planets&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span> body <span class="op">}</span>)
<span class="op">}</span></code></pre></div>
<h2 id="domains">Domains</h2>
<p>Whenever an Action is pushed into a repo (the project’s instance of Microcosm), it leans on Domains to transform data.</p>
<p>Domains are assigned to a specified key in a Microcosm instance, subscribing to specific action states (<code>done</code>, <code>error</code>, <code>cancelled</code>…). As actions are pushed into a Microcosm, Domains are ultimately responsible for how those actions turn into data modifications useable by the presentation layer.</p>
<p>Domains also implement a <code>register()</code> method to subscribe to actions:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">class</span> Planets <span class="op">{</span>
  <span class="at">getInitialState</span> () <span class="op">{</span>
    <span class="cf">return</span> []
  <span class="op">}</span>
  <span class="at">append</span> (planets<span class="op">,</span> body)  <span class="op">{</span>
    <span class="cf">return</span> <span class="va">planets</span>.<span class="at">concat</span>(body)
  <span class="op">}</span>
  <span class="at">register</span> () <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      [createPlanet]<span class="op">:</span> <span class="kw">this</span>.<span class="at">append</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Presenters actively listen to state changes in their repo. As they receive updates, they pass them down into the view layer to update the UI.</p>
<h2 id="effects">Effects</h2>
<p><strong>Domains must be free of side-effects.</strong> Microcosm may call a domain handler multiple times when resolving multiple asynchronous actions. This is inconvenient for one-time side-effects, or behavior that doesn’t relate to data operaitons.</p>
<p>Effects provide a way to formally declare side-effects in a way that is easy to track, setup and teardown.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">class</span> Logger <span class="op">{</span>
  <span class="at">trackError</span> (repo<span class="op">,</span> error)  <span class="op">{</span>
    <span class="va">console</span>.<span class="at">error</span>(<span class="st">&#39;Failed to create planet&#39;</span><span class="op">,</span> error)
  <span class="op">}</span>
  <span class="at">register</span> () <span class="op">{</span>
    <span class="cf">return</span> <span class="op">{</span>
      [<span class="va">createPlanet</span>.<span class="at">error</span>]<span class="op">:</span> <span class="kw">this</span>.<span class="at">trackError</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<h2 id="quick-recap">Quick Recap</h2>
<p>Data flows downward, transformed by presenters into a form useful to the view layer. As users interact with the app, actions are dispatched to domains and effects to handle necessary state changes and side-effects.</p></div>
    </main>

    <footer class="footer">
      <div class="footer__inner">
        <nav class="footer__left">
          <a href="https://www.npmjs.com/package/microcosm">
            <img src="https://img.shields.io/npm/v/microcosm.svg?style=flat-square" alt="View package on NPM" />
          </a>
          <a href="http://code.viget.com/microcosm/changelog.html">Changelog</a>
          <a href="https://github.com/vigetlabs/microcosm">Source</a>
        </nav>
        <div class="footer__right">
          Built with patience and time by <a href="https://viget.com">●° Viget</a>
        </div>
      </div>
    </footer>

    <script>
      // set active links
      (function() {
        var location = window.location.toString()

        for (var i = 0; i < document.links.length; i++) {
          if (document.links[i].href === location) {
            document.links[i].classList.add('active')
          }
        }
      }())
    </script>
  </body>
</html>
